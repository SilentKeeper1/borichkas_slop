<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è ‚Äî Borichkas slop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet" />
  <style>
    #map {
      height: 400px;
      width: 100%;
      margin-top: 2rem;
      border-radius: 10px;
      overflow: hidden;
    }
    .note {
      margin-top: 1rem;
      font-style: italic;
      color: #555;
    }
    #zoneWarning {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <h1 class="mb-4">üßæ –û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h1>

    {% if not cart %}
      <div class="alert alert-info">
        –í–∞—à –∫–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π. <a href="{{ url_for('menu') }}">–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –º–µ–Ω—é</a>
      </div>
    {% else %}
      <table class="table align-middle">
        <thead>
          <tr>
            <th>–ù–∞–∑–≤–∞</th>
            <th>–¶—ñ–Ω–∞</th>
            <th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
            <th>–°—É–º–∞</th>
          </tr>
        </thead>
        <tbody>
          {% for item in cart %}
          <tr>
            <td>{{ item.name }}</td>
            <td>{{ item.price }} ‚Ç¥</td>
            <td>{{ item.quantity }}</td>
            <td>{{ item.price * item.quantity }} ‚Ç¥</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

  <div class="d-flex justify-content-between align-items-center mt-4">
    <h4>–ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞: <span class="text-success">{{ total }} ‚Ç¥</span></h4>
    <form method="POST" action="{{ url_for('create_order') }}" class="d-flex flex-column flex-sm-row align-items-start gap-2">
      <div>
        <label for="addressInput" class="form-label mb-1">–ê–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏:</label>
        <input type="text" name="address" id="addressInput" class="form-control" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥, –ö–∏—ó–≤, –≤—É–ª. –•—Ä–µ—â–∞—Ç–∏–∫ 10" required>
      </div>
      <div class="d-flex flex-column">
        <a href="{{ url_for('menu') }}" class="btn btn-outline-secondary mb-2">–ù–∞–∑–∞–¥ –¥–æ –º–µ–Ω—é</a>
        <button type="submit" class="btn btn-success">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
      </div>
    </form>
  </div>
{% endif %}

    <div id="map"></div>

    <div class="note">
      ‚ö†Ô∏è –¢–∏–º—á–∞—Å–æ–≤–æ –Ω–µ –¥–æ—Å—Ç–∞–≤–ª—è—î–º–æ –Ω–∞ –æ–∫—É–ø–æ–≤–∞–Ω—ñ —Ç–µ—Ä–∏—Ç–æ—Ä—ñ—ó –£–∫—Ä–∞—ó–Ω–∏. –ú–∏ –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ –ø–æ–≤–µ—Ä–Ω–µ–º–æ—Å—è –ø—ñ—Å–ª—è –¥–µ–æ–∫—É–ø–∞—Ü—ñ—ó ‚ù§Ô∏èüá∫üá¶
    </div>

<!-- –ê–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ -->
<div class="mt-5">
  <label for="addressInput" class="form-label">–í–≤–µ–¥—ñ—Ç—å –∞–¥—Ä–µ—Å—É –¥–æ—Å—Ç–∞–≤–∫–∏:</label>
  <input type="text" id="addressInput" class="form-control" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥, –ö–∏—ó–≤, –≤—É–ª. –•—Ä–µ—â–∞—Ç–∏–∫ 10">
  <button class="btn btn-success   mt-2" onclick="checkDeliveryZone()">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∞–¥—Ä–µ—Å—É</button>
</div>

<div id="zoneWarning" class="text-danger mt-2" style="display:none;">
  ‚ö†Ô∏è –í–∞—à–∞ –∞–¥—Ä–µ—Å–∞ –ø–æ–∑–∞ –∑–æ–Ω–æ—é –¥–æ—Å—Ç–∞–≤–∫–∏!
</div>
<div id="zoneSuccess" class="text-success mt-2" style="display:none;">
  ‚úÖ –ê–¥—Ä–µ—Å–∞ –≤ –º–µ–∂–∞—Ö –∑–æ–Ω–∏ –¥–æ—Å—Ç–∞–≤–∫–∏.
</div>


<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>
  // –°–ø–µ—Ä—à—É –æ–≥–æ–ª–æ—à—É—î–º–æ –∑–æ–Ω–∏ –¥–æ—Å—Ç–∞–≤–∫–∏
  const regions = {
    'green': [
      ['–í—ñ–Ω–Ω–∏—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å', 49.2331, 28.4682],
      ['–í–æ–ª–∏–Ω—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å', 50.7472, 25.3254],
      ['–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å', 48.4647, 35.0462],
      ['–ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å', 50.2649, 28.6767],
      ['–ó–∞–∫–∞—Ä–ø–∞—Ç—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å', 48.6208, 22.2879],
      ['–ó–∞–ø–æ—Ä—ñ–∑—å–∫–∞ –æ–±–ª–∞—Å—Ç—å', 47.8388, 35.1396],
      ['–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å', 48.9226, 24.7111],
      ['–ö–∏—ó–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å', 50.4017, 30.2520],
      ['–ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å', 48.5080, 32.2597],
      ['–õ—å–≤—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å', 49.8397, 24.0297],
      ['–ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å', 46.9750, 31.9946],
      ['–û–¥–µ—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å', 46.4825, 30.7233],
      ['–ü–æ–ª—Ç–∞–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å', 49.5883, 34.5514],
      ['–†—ñ–≤–Ω–µ–Ω—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å', 50.6199, 26.2516],
      ['–°—É–º—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å', 50.9077, 34.7981],
      ['–¢–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å', 49.5535, 25.5948],
      ['–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å', 49.9935, 36.2304],
      ['–•–µ—Ä—Å–æ–Ω—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å', 46.6354, 32.6169],
      ['–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å', 49.4215, 26.9965],
      ['–ß–µ—Ä–∫–∞—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å', 49.4444, 32.0598],
      ['–ß–µ—Ä–Ω—ñ–≤–µ—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å', 48.2915, 25.9358],
      ['–ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å', 51.4982, 31.2893],
      ['–ö—Ä–∏–≤–∏–π –†—ñ–≥ (–º—ñ—Å—Ç–æ)', 47.9105, 33.3918]
    ],
    'blue': [
      ['–î–æ–ª—å–Ω—î—à–ª—å–æ–Ω—Å—å–∫–µ', 51.1079, 17.0385],
      ['–ö—É—è–≤—Å—å–∫–æ-–ü–æ–º–æ—Ä—Å—å–∫–µ', 53.0138, 18.5984],
      ['–õ—é–±—É—Å—å–∫–µ', 52.2456, 15.2259],
      ['–õ–æ–¥–∑—å–∫–µ', 51.7592, 19.4550],
      ['–ú–∞–∑–æ–≤–µ—Ü—å–∫–µ', 52.2297, 21.0122],
      ['–û–ø–æ–ª—å—Å—å–∫–µ', 50.6751, 17.9213],
      ['–ü—ñ–¥–∫–∞—Ä–ø–∞—Ç—Å—å–∫–µ', 49.7831, 22.7671],
      ['–ü—ñ–¥–ª—è—Å—å–∫–µ', 52.7047, 23.2525],
      ['–ü–æ–º–æ—Ä—Å—å–∫–µ', 54.3520, 18.6466],
      ['–°–≤–µ–Ω—Ç–æ–∫—à–∏—Å—å–∫–µ', 50.8661, 20.6286],
      ['–í–∞—Ä–º—ñ–Ω—Å—å–∫–æ-–ú–∞–∑—É—Ä—Å—å–∫–µ', 53.7784, 20.4801],
      ['–í–µ–ª–∏–∫–æ–ø–æ–ª—å—Å—å–∫–µ', 52.4064, 16.9252],
      ['–ó–∞—Ö—ñ–¥–Ω–æ–ø–æ–º–æ—Ä—Å—å–∫–µ', 53.4285, 14.5528],
      ['–õ—é–±–ª—ñ–Ω—Å—å–∫–µ', 51.2465, 22.5684],
      ['–ú–∞–ª–æ–ø–æ–ª—å—Å—å–∫–µ', 50.0647, 19.9450],
      ['–°—ñ–ª–µ–∑—å–∫–µ', 50.2649, 19.0238]
    ],
    'red': [
      ['Region Hovedstaden', 55.6759, 12.5655],
      ['Region Sj√¶lland', 55.4028, 11.3546],
      ['Region Syddanmark', 55.3556, 10.3450],
      ['Region Midtjylland', 56.1629, 9.5870],
      ['Region Nordjylland', 57.0488, 9.9217]
    ],
    'white': [
      ['–°—Ç–∞–Ω—Ü—ñ—è "–ê–∫–∞–¥–µ–º—ñ–∫ –í–µ—Ä–Ω–∞–¥—Å—å–∫–∏–π"', -65.2510, -64.2610]
    ]
  };

  // –°—Ç–≤–æ—Ä—é—î–º–æ –º–∞—Å–∏–≤ deliveryZones –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∞–¥—Ä–µ—Å
  const deliveryZones = [];
  for (const [color, areas] of Object.entries(regions)) {
    areas.forEach(([name, lat, lon]) => {
      deliveryZones.push({ name, lat, lon });
    });
  }

  // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–∞—Ä—Ç–∏
  const map = L.map('map').setView([52, 20], 5);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 10,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // –§—É–Ω–∫—Ü—ñ—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –∫—Ä—É–≥—ñ–≤ –∑–æ–Ω –¥–æ—Å—Ç–∞–≤–∫–∏ –Ω–∞ –∫–∞—Ä—Ç—É
  function addRegionCircle(lat, lon, radius, color, name) {
    L.circle([lat, lon], {
      color,
      fillColor: color,
      fillOpacity: 0.2,
      radius
    }).addTo(map).bindPopup(name);
  }

  // –ú–∞–ª—é—î–º–æ –∫—Ä—É–≥–∏ –¥–ª—è –∫–æ–∂–Ω–æ—ó –∑–æ–Ω–∏
  for (const [color, areas] of Object.entries(regions)) {
    areas.forEach(([name, lat, lon]) => {
      const radius = color === 'green' ? 50000 : color === 'blue' ? 35000 : color === 'red' ? 25000 : 20000;
      addRegionCircle(lat, lon, radius, color, name + (color === 'white' ? ' (–ê–Ω—Ç–∞—Ä–∫—Ç–∏–¥–∞)' : ''));
    });
  }

  // –§—É–Ω–∫—Ü—ñ—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –≤–≤–µ–¥–µ–Ω–æ—ó –∞–¥—Ä–µ—Å–∏
  async function checkDeliveryZone() {
    const input = document.getElementById('addressInput').value;
    const warning = document.getElementById('zoneWarning');
    const success = document.getElementById('zoneSuccess');

    warning.style.display = 'none';
    success.style.display = 'none';

    if (!input.trim()) return;

    try {
      const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(input)}`);
      const data = await response.json();

      if (!data.length) {
        warning.textContent = '‚ùå –ê–¥—Ä–µ—Å—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!';
        warning.style.display = 'block';
        return;
      }

      const userLat = parseFloat(data[0].lat);
      const userLon = parseFloat(data[0].lon);

      const inZone = deliveryZones.some(region => {
        const dLat = region.lat - userLat;
        const dLon = region.lon - userLon;
        const distance = Math.sqrt(dLat * dLat + dLon * dLon) * 111000; // –ø—Ä–∏–±–ª–∏–∑–Ω–æ –º–µ—Ç—Ä–∏

        const radius = region.name.includes('–£–∫—Ä–∞—ó–Ω–∞') ? 50000 :
                       region.name.includes('–ü–æ–ª—å—â–∞') ? 35000 :
                       region.name.includes('–î–∞–Ω—ñ—è') ? 25000 : 20000;

        return distance <= radius;
      });

      if (inZone) {
        success.style.display = 'block';
      } else {
        warning.style.display = 'block';
      }

    } catch (err) {
      warning.textContent = '‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ –∞–¥—Ä–µ—Å–∏!';
      warning.style.display = 'block';
    }
  }
</script>

  </body>
</html>
